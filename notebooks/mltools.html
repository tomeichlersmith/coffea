<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running inference tools &mdash; coffea 0.1.dev1+gcc4c391 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Coffea Histograms (deprecated)" href="histograms.html" />
    <link rel="prev" title="Coffea Processors" href="processor.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            coffea
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installing coffea</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Coffea by Example</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nanoevents.html">Reading data with coffea NanoEvents</a></li>
<li class="toctree-l2"><a class="reference internal" href="applying_corrections.html">Applying corrections to columnar data</a></li>
<li class="toctree-l2"><a class="reference internal" href="accumulators.html">Analysis tools and accumulators</a></li>
<li class="toctree-l2"><a class="reference internal" href="processor.html">Coffea Processors</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running inference tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Why-these-wrapper-tools-are-needed">Why these wrapper tools are needed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Example-using-ParticleNet-like-jet-variable-calculation-using-PyTorch">Example using ParticleNet-like jet variable calculation using PyTorch</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Comments-about-generalizing-to-other-ML-tools">Comments about generalizing to other ML tools</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="histograms.html">Coffea Histograms (deprecated)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts.html">Coffea concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">API Reference Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">coffea</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../examples.html">Coffea by Example</a></li>
      <li class="breadcrumb-item active">Running inference tools</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/mltools.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Running-inference-tools">
<h1>Running inference tools<a class="headerlink" href="#Running-inference-tools" title="Permalink to this heading"></a></h1>
<p>As machine learning (ML) becomes more popular in HEP analysis, <code class="docutils literal notranslate"><span class="pre">coffea</span></code> also provide tools to assist with using ML tools within the coffea framework. For training and validation, you would likely need custom data mangling tools to convert HEP data formats (<a class="reference external" href="https://twiki.cern.ch/twiki/bin/view/CMSPublic/WorkBookNanoAOD">NanoAOD</a>, <a class="reference external" href="https://github.com/cms-jet/PFNano">PFNano</a>) to a format that best interfaces with the ML tool of choice, as for training and validation, you typical want to
have fine control over what computation is done. For more advanced use cases of data mangling and data saving, refer to the <a class="reference external" href="https://awkward-array.org/doc/main/user-guide/how-to-restructure.html">awkward array manual</a> and <a class="reference external" href="https://uproot.readthedocs.io/en/latest/basic.html#writing-ttrees-to-a-file">uproot</a>/<a class="reference external" href="https://awkward-array.org/doc/main/reference/generated/ak.to_parquet.html">parquet</a> write operations for saving intermediate states. The helper tools provided in coffea focuses on ML
inference, where ML tool outputs are used as another variable to be used in the event/object selection chain.</p>
<section id="Why-these-wrapper-tools-are-needed">
<h2>Why these wrapper tools are needed<a class="headerlink" href="#Why-these-wrapper-tools-are-needed" title="Permalink to this heading"></a></h2>
<p>The typical operation of using ML inference tools in the awkward/coffea analysis tools involves the conversion and padding of awkward array to ML tool containers (usually something that is <code class="docutils literal notranslate"><span class="pre">numpy</span></code>-compatible), run the inference, then convert-and-truncate back into the awkward array syntax required for the analysis chain to continue. With awkward arrays’ laziness now being handled entirely by <code class="docutils literal notranslate"><span class="pre">`dask</span></code> &lt;<a class="reference external" href="https://dask-awkward.readthedocs.io/en/stable/gs-limitations.html">https://dask-awkward.readthedocs.io/en/stable/gs-limitations.html</a>&gt;`__, the conversion
operation of awkward array to other array types needs to be wrapped in a way that is understandable to <code class="docutils literal notranslate"><span class="pre">dask</span></code>. The packages in the <code class="docutils literal notranslate"><span class="pre">ml_tools</span></code> package attempts to wrap the common tools used by the HEP community with a common interface to reduce the verbosity of the code on the analysis side.</p>
</section>
<section id="Example-using-ParticleNet-like-jet-variable-calculation-using-PyTorch">
<h2>Example using ParticleNet-like jet variable calculation using PyTorch<a class="headerlink" href="#Example-using-ParticleNet-like-jet-variable-calculation-using-PyTorch" title="Permalink to this heading"></a></h2>
<p>The example given in this notebook be using <code class="docutils literal notranslate"><span class="pre">`pytorch</span></code> &lt;<a class="reference external" href="https://pytorch.org/">https://pytorch.org/</a>&gt;`__ to calculate a jet-level discriminant using its constituent particles. An example for how to construct such a <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> network can be found in the docs file, but for <code class="docutils literal notranslate"><span class="pre">mltools</span></code> in coffea, we only support the <a class="reference external" href="https://pytorch.org/">TorchScript</a> format files to load models to ensure operability when scaling to clusters. Let us first start by downloading the example ParticleNet model file and a small
<code class="docutils literal notranslate"><span class="pre">PFNano</span></code> compatible file, and a simple function to open the <code class="docutils literal notranslate"><span class="pre">PFNano</span></code> with and without dask.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>wget<span class="w"> </span>--quiet<span class="w"> </span>-O<span class="w"> </span>model.pt<span class="w"> </span>https://github.com/CoffeaTeam/coffea/raw/ml_tools/tests/samples/triton_models_test/pn_test/1/model.pt
<span class="o">!</span>wget<span class="w"> </span>--quiet<span class="w"> </span>-O<span class="w"> </span>pfnano.root<span class="w"> </span>https://github.com/CoffeaTeam/coffea/raw/ml_tools/tests/samples/pfnano.root
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">coffea.nanoevents</span> <span class="kn">import</span> <span class="n">NanoEventsFactory</span>
<span class="kn">from</span> <span class="nn">coffea.nanoevents.schemas</span> <span class="kn">import</span> <span class="n">PFNanoAODSchema</span>


<span class="k">def</span> <span class="nf">open_events</span><span class="p">(</span><span class="n">permit_dask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">NanoEventsFactory</span><span class="o">.</span><span class="n">from_root</span><span class="p">(</span>
        <span class="s2">&quot;file:./pfnano.root&quot;</span><span class="p">,</span>
        <span class="n">schemaclass</span><span class="o">=</span><span class="n">PFNanoAODSchema</span><span class="p">,</span>
        <span class="n">permit_dask</span><span class="o">=</span><span class="n">permit_dask</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">factory</span><span class="o">.</span><span class="n">events</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<p>Now we prepare a class to handle inference request by extending the <code class="docutils literal notranslate"><span class="pre">mltools.torch_wrapper</span></code> class. As the base class cannot know anything about the data mangling required for the users particular model, we will need to overload at least the method <code class="docutils literal notranslate"><span class="pre">prepare_awkward</span></code>:</p>
<ul>
<li><p>The input can be an arbitrary number of awkward arrays or dask awkward array (but never a mix of dask/non-dask array). In this example, we will be passing in the event array.</p></li>
<li><p>The output should be single tuple <code class="docutils literal notranslate"><span class="pre">a</span></code> + single dictionary <code class="docutils literal notranslate"><span class="pre">b</span></code>, this is to ensure that arbitrarily complicated outputs can be passed to the underlying <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> model instance like <code class="docutils literal notranslate"><span class="pre">model(*a,</span> <span class="pre">**b)</span></code>. The contents of <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> should be <code class="docutils literal notranslate"><span class="pre">numpy</span></code>-compatible awkward-like arrays: if the inputs are non-dask awkward arrays, the return should also be non-dask awkward arrays that can be trivially converted to <code class="docutils literal notranslate"><span class="pre">numpy</span></code> arrays via a <code class="docutils literal notranslate"><span class="pre">ak.to_numpy</span></code> call; if the inputs are dask awkward
arrays, the return should be still be dask awkward arrays that can be trivially converted via a <code class="docutils literal notranslate"><span class="pre">to_awkward().to_numpy()</span></code> call. To minimize changes to the code, a simple <code class="docutils literal notranslate"><span class="pre">dask_awkward/awkward</span></code> switcher <code class="docutils literal notranslate"><span class="pre">get_awkward_lib</span></code> is provided, as there should be (near)-perfect feature parity between the dask and non-dask arrays.</p>
<p>In this ParticleNet-like example, the model expects the following inputs:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">N</span></code> jets x <code class="docutils literal notranslate"><span class="pre">2</span></code> coordinate x <code class="docutils literal notranslate"><span class="pre">100</span></code> constituents “points” array, representing the constituent coordinates.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">N</span></code> jets x <code class="docutils literal notranslate"><span class="pre">5</span></code> feature x <code class="docutils literal notranslate"><span class="pre">100</span></code> constituents “features” array, representing the constituent features of interest to be used for inference.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">N</span></code> jets x <code class="docutils literal notranslate"><span class="pre">1</span></code> mask x <code class="docutils literal notranslate"><span class="pre">100</span></code> constituent “mask” array, representing whether a constituent should be masked from the inference request.</p></li>
</ul>
<p>In this case, we will need to flatten the <code class="docutils literal notranslate"><span class="pre">E</span></code> events x <code class="docutils literal notranslate"><span class="pre">N</span></code> jets structure, then, we will need to stack the constituent attributes of interest via <code class="docutils literal notranslate"><span class="pre">ak.concatenate</span></code> into a single array.</p>
</li>
</ul>
<p>After defining this minimum class, we can attempt to run inference using the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method defined in the base class. Notice that overloading this single method will automatically allow for the inference to be called on both awkward and dask-awkward.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">coffea.ml_tools.torch_wrapper</span> <span class="kn">import</span> <span class="n">torch_wrapper</span>
<span class="kn">import</span> <span class="nn">awkward</span>
<span class="kn">import</span> <span class="nn">dask_awkward</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">class</span> <span class="nc">ParticleNetExample1</span><span class="p">(</span><span class="n">torch_wrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prepare_awkward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
        <span class="n">ak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_awkward_lib</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="n">jets</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">Jet</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ak</span><span class="o">.</span><span class="n">fill_none</span><span class="p">(</span>
                <span class="n">ak</span><span class="o">.</span><span class="n">pad_none</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Human readable version of what the inputs are</span>
        <span class="c1"># Each array is a N jets x 100 constituent array</span>
        <span class="n">imap</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;deta&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">eta</span> <span class="o">-</span> <span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">eta</span><span class="p">),</span>
                <span class="s2">&quot;dphi&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">delta_phi</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="p">)),</span>
            <span class="p">},</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">delta_r</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="p">)),</span>
                <span class="s2">&quot;lpt&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">pt</span><span class="p">)),</span>
                <span class="s2">&quot;lptf&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">pt</span> <span class="o">/</span> <span class="n">jets</span><span class="o">.</span><span class="n">pt</span><span class="p">)),</span>
                <span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">d0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="s2">&quot;f2&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">dz</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="p">},</span>
            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">ak</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">pt</span><span class="p">)),</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Compacting the array elements into the desired dimension using</span>
        <span class="c1"># ak.concatenate</span>
        <span class="n">retmap</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">ak</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">imap</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># Returning everything using a dictionary. Also perform type conversion!</span>
        <span class="k">return</span> <span class="p">(),</span> <span class="p">{</span>
            <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">ak</span><span class="o">.</span><span class="n">values_astype</span><span class="p">(</span><span class="n">retmap</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">ak</span><span class="o">.</span><span class="n">values_astype</span><span class="p">(</span><span class="n">retmap</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">ak</span><span class="o">.</span><span class="n">values_astype</span><span class="p">(</span><span class="n">retmap</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="s2">&quot;float16&quot;</span><span class="p">),</span>
        <span class="p">}</span>


<span class="c1"># Setting up the model container</span>
<span class="n">pn_example1</span> <span class="o">=</span> <span class="n">ParticleNetExample1</span><span class="p">(</span><span class="s2">&quot;model.pt&quot;</span><span class="p">)</span>

<span class="c1"># Running on awkward arrays</span>
<span class="n">ak_events</span> <span class="o">=</span> <span class="n">open_events</span><span class="p">(</span><span class="n">permit_dask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ak_results</span> <span class="o">=</span> <span class="n">pn_example1</span><span class="p">(</span><span class="n">ak_events</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Awkward results:&quot;</span><span class="p">,</span> <span class="n">ak_results</span><span class="p">)</span>  <span class="c1"># Runs fine!</span>

<span class="c1"># Running on dask_awkward array</span>
<span class="n">dask_events</span> <span class="o">=</span> <span class="n">open_events</span><span class="p">(</span><span class="n">permit_dask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dask_results</span> <span class="o">=</span> <span class="n">pn_example1</span><span class="p">(</span><span class="n">dask_events</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dask awkward results:&quot;</span><span class="p">,</span> <span class="n">dask_results</span><span class="p">)</span>  <span class="c1"># Also runs file!</span>

<span class="c1"># Checking that the results are identical</span>
<span class="k">assert</span> <span class="n">awkward</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dask_results</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="o">==</span> <span class="n">ak_results</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ensc/VirtualENV/coffea-test/lib/python3.8/site-packages/coffea/ml_tools/helper.py:163: UserWarning: No format checks were performed on input!
  warnings.warn(&#34;No format checks were performed on input!&#34;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Awkward results: [[0.0693, -0.0448], [0.0678, -0.0451], ..., [0.0616, ...], [0.0587, -0.0172]]
Dask awkward results: dask.awkward&lt;numpy_call_ParticleNetExample1_143880bd51265ab5cb0ff3b61a1522c0, npartitions=1&gt;
</pre></div></div>
</div>
<p>For each jet in the input to the <code class="docutils literal notranslate"><span class="pre">torch</span></code> model, the model returns a 2-tuple probability value. Without additional specification, the <code class="docutils literal notranslate"><span class="pre">torch_wrapper</span></code> class performs a trival conversion of <code class="docutils literal notranslate"><span class="pre">ak.from_numpy</span></code> of the torch model’s output. We can specify that we want to fold this back into nested structure by overloading the <code class="docutils literal notranslate"><span class="pre">postprocess_awkward</span></code> method of the class.</p>
<p>For the ParticleNet example we are going perform additional computation for the conversion back to awkward array formats:</p>
<ul class="simple">
<li><p>Calculate the <code class="docutils literal notranslate"><span class="pre">softmax</span></code> method for the return of each jet (commonly used as the singular ML inference “scores”)</p></li>
<li><p>Fold the computed <code class="docutils literal notranslate"><span class="pre">softmax</span></code> array back into nested structure that is compatible with the original events.Jet array.</p></li>
</ul>
<p>Notice that the inputs of the <code class="docutils literal notranslate"><span class="pre">postprocess_awkward</span></code> method is different from the <code class="docutils literal notranslate"><span class="pre">prepare_awkward</span></code> method, only by that the first argument is the return array of the model inference after the trivial <code class="docutils literal notranslate"><span class="pre">from_numpy</span></code> conversion. Notice that the return_array can be dask arrays, so the awkward/dask-awkward switching function should also be used in this method.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ParticleNetExample2</span><span class="p">(</span><span class="n">ParticleNetExample1</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">postprocess_awkward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_array</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
        <span class="n">ak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_awkward_lib</span><span class="p">(</span><span class="n">return_array</span><span class="p">)</span>
        <span class="n">softmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">return_array</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">ak</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">return_array</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">njets</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ak</span><span class="o">.</span><span class="n">unflatten</span><span class="p">(</span><span class="n">softmax</span><span class="p">,</span> <span class="n">njets</span><span class="p">)</span>


<span class="n">pn_example2</span> <span class="o">=</span> <span class="n">ParticleNetExample2</span><span class="p">(</span><span class="s2">&quot;model.pt&quot;</span><span class="p">)</span>

<span class="c1"># Running on awkward</span>
<span class="n">ak_events</span> <span class="o">=</span> <span class="n">open_events</span><span class="p">(</span><span class="n">permit_dask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ak_jets</span> <span class="o">=</span> <span class="n">ak_events</span><span class="o">.</span><span class="n">Jet</span>
<span class="n">ak_jets</span><span class="p">[</span><span class="s2">&quot;MLresults&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn_example2</span><span class="p">(</span><span class="n">ak_events</span><span class="p">)</span>
<span class="n">ak_events</span><span class="p">[</span><span class="s2">&quot;Jet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ak_jets</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ak_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span><span class="p">)</span>

<span class="c1"># Running on dask awkward</span>
<span class="n">dask_events</span> <span class="o">=</span> <span class="n">open_events</span><span class="p">(</span><span class="n">permit_dask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dask_jets</span> <span class="o">=</span> <span class="n">dask_events</span><span class="o">.</span><span class="n">Jet</span>
<span class="n">dask_jets</span><span class="p">[</span><span class="s2">&quot;MLresults&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn_example2</span><span class="p">(</span><span class="n">dask_events</span><span class="p">)</span>
<span class="n">dask_events</span><span class="p">[</span><span class="s2">&quot;Jet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dask_jets</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dask_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">awkward</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ak_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span> <span class="o">==</span> <span class="n">dask_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[0.528, 0.528, 0.524, 0.523, 0.521, 0.52, 0.519, 0.519], ..., [0.528, ...]]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ensc/VirtualENV/coffea-test/lib/python3.8/site-packages/dask_awkward/lib/structure.py:751: UserWarning: Please ensure that dask.awkward&lt;count, npartitions=1&gt;
        is partitionwise-compatible with dask.awkward&lt;divide, npartitions=1&gt;
        (e.g. counts comes from a dak.num(array, axis=1)),
        otherwise this unflatten operation will fail when computed!
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dask.awkward&lt;MLresults, npartitions=1&gt;
</pre></div></div>
</div>
<p>Of course, the implementation of the classes above can be written in a single class. Here is a copy-and-paste implementation of the class with all the functionality described in the cells above:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ParticleNetExample</span><span class="p">(</span><span class="n">torch_wrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prepare_awkward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
        <span class="n">ak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_awkward_lib</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="n">jets</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">Jet</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ak</span><span class="o">.</span><span class="n">fill_none</span><span class="p">(</span>
                <span class="n">ak</span><span class="o">.</span><span class="n">pad_none</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Human readable version of what the inputs are</span>
        <span class="c1"># Each array is a N jets x 100 constituent array</span>
        <span class="n">imap</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;deta&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">eta</span> <span class="o">-</span> <span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">eta</span><span class="p">),</span>
                <span class="s2">&quot;dphi&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">delta_phi</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="p">)),</span>
            <span class="p">},</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">delta_r</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="p">)),</span>
                <span class="s2">&quot;lpt&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">pt</span><span class="p">)),</span>
                <span class="s2">&quot;lptf&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">pt</span> <span class="o">/</span> <span class="n">jets</span><span class="o">.</span><span class="n">pt</span><span class="p">)),</span>
                <span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">d0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="s2">&quot;f2&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">dz</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="p">},</span>
            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">ak</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">jets</span><span class="o">.</span><span class="n">constituents</span><span class="o">.</span><span class="n">pf</span><span class="o">.</span><span class="n">pt</span><span class="p">)),</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Compacting the array elements into the desired dimension using</span>
        <span class="c1"># ak.concatenate</span>
        <span class="n">retmap</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">ak</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">imap</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># Returning everything using a dictionary. Also take care of type</span>
        <span class="c1"># conversion here.</span>
        <span class="k">return</span> <span class="p">(),</span> <span class="p">{</span>
            <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">ak</span><span class="o">.</span><span class="n">values_astype</span><span class="p">(</span><span class="n">retmap</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
            <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">ak</span><span class="o">.</span><span class="n">values_astype</span><span class="p">(</span><span class="n">retmap</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">ak</span><span class="o">.</span><span class="n">values_astype</span><span class="p">(</span><span class="n">retmap</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="s2">&quot;float16&quot;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">postprocess_awkward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_array</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
        <span class="n">ak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_awkward_lib</span><span class="p">(</span><span class="n">return_array</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
        <span class="n">softmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">return_array</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">ak</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">return_array</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">njets</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ak</span><span class="o">.</span><span class="n">unflatten</span><span class="p">(</span><span class="n">softmax</span><span class="p">,</span> <span class="n">njets</span><span class="p">)</span>


<span class="n">pn_example</span> <span class="o">=</span> <span class="n">ParticleNetExample</span><span class="p">(</span><span class="s2">&quot;model.pt&quot;</span><span class="p">)</span>

<span class="c1"># Running on awkward arrays</span>
<span class="n">ak_events</span> <span class="o">=</span> <span class="n">open_events</span><span class="p">(</span><span class="n">permit_dask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ak_jets</span> <span class="o">=</span> <span class="n">ak_events</span><span class="o">.</span><span class="n">Jet</span>
<span class="n">ak_jets</span><span class="p">[</span><span class="s2">&quot;MLresults&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn_example</span><span class="p">(</span><span class="n">ak_events</span><span class="p">)</span>
<span class="n">ak_events</span><span class="p">[</span><span class="s2">&quot;Jet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ak_jets</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ak_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span><span class="p">)</span>

<span class="c1"># Running on dask awkward arrays</span>
<span class="n">dask_events</span> <span class="o">=</span> <span class="n">open_events</span><span class="p">(</span><span class="n">permit_dask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dask_jets</span> <span class="o">=</span> <span class="n">dask_events</span><span class="o">.</span><span class="n">Jet</span>
<span class="n">dask_jets</span><span class="p">[</span><span class="s2">&quot;MLresults&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn_example</span><span class="p">(</span><span class="n">dask_events</span><span class="p">)</span>
<span class="n">dask_events</span><span class="p">[</span><span class="s2">&quot;Jet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dask_jets</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dask_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span><span class="p">)</span>
<span class="c1"># Checking that we get identical results</span>
<span class="k">assert</span> <span class="n">awkward</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dask_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="o">==</span> <span class="n">ak_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dask_awkward</span><span class="o">.</span><span class="n">necessary_columns</span><span class="p">(</span><span class="n">dask_events</span><span class="o">.</span><span class="n">Jet</span><span class="o">.</span><span class="n">MLresults</span><span class="p">))</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[0.528, 0.528, 0.524, 0.523, 0.521, 0.52, 0.519, 0.519], ..., [0.528, ...]]
dask.awkward&lt;MLresults, npartitions=1&gt;
{&#39;from-uproot-9ff71c2b6c06eb15f091c3e41ead5497&#39;: [&#39;Jet.pt&#39;, &#39;PFCands.d0&#39;, &#39;JetPFCands.pFCandsIdxG&#39;, &#39;PFCands.phi&#39;, &#39;Jet.phi&#39;, &#39;Jet.eta&#39;, &#39;PFCands.eta&#39;, &#39;PFCands.pt&#39;, &#39;Jet.pFCandsIdxG&#39;, &#39;PFCands.dz&#39;]}
</pre></div></div>
</div>
<p>In particular, analyzers should check that the last line contains only the branches required for ML inference; if there are many non-required branches, this may lead the significant performance penalties.</p>
<p>As per other dask tools, the users can extract how dask is analyzing the processing the computation routines using the following snippet.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dask_results</span><span class="o">.</span><span class="n">dask</span><span class="p">)</span>
<span class="n">dask_results</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">optimize_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
HighLevelGraph with 103 layers.
&lt;dask.highlevelgraph.HighLevelGraph object at 0x7f2fc7d9a550&gt;
 0. from-uproot-40ed9ba7c4cc45e94105e61283f124a3
 1. JetPFCands-f14e9b07eb3c690873f7ea00af7ee8eb
 2. PFCands-d4a8642b8c01c731c7d43e4bde63dba7
 3. JetPFCands-6271438633eb0569493e2a65beb35cb1
 4. PFCands-988dd86d5d366180aedd789b9fd97788
 5. JetPFCands-b9487676f464447b15804d03bca317da
 6. PFCands-915a7a9dd26d7fb2110a52bc38fae16a
 7. JetPFCands-1535528183c6524bb8872d941e3a2320
 8. PFCands-a4e509a69376ee57025fb7c7bfbf7903
 9. JetPFCands-0e8588a67ca85b26e05c720442904a9d
 10. PFCands-e95bd3adde3a14965f38e941f6b912c3
 11. JetPFCands-f14ebf216a7d1a1761a234ad85c21a54
 12. PFCands-18e5d62f1b50a1c0edafa1f39ebe765d
 13. JetPFCands-6beb51836e39d136853699523596bf0e
 14. PFCands-27deeb09b87b1ac27f7199f705a0b003
 15. JetPFCands-8da6714502a3b61dd64f44221e6d0299
 16. PFCands-7e6e94c83dcffeb122571204de8d1392
 17. Jet-fa3ab6fd9c4726ec37bac08fbeed78c9
 18. flatten-4b26fe19858d9257a26a602aef991da8
 19. pFCandsIdxG-e6ffb60d1c3a5132916c6e67aa728476
 20. _apply_global_index-deae4d7cd7d1e0d8d803f96bc280cfa6
 21. pFCandsIdxG-2edff7ce8b2126a66b44af833d8b713b
 22. _apply_global_index-0d462573e4213b3c2d08e82f54e93c0f
 23. pt-506e1c8af61c15ef17f71c0f91448da4
 24. ones-like-4cecc07513ea49b0b40dff2fd351a5b9
 25. pad-none-62e19b5d7cbf908345333361b2c3676f
 26. fill-none-d69152c91524f0008baeabefd0ecee5e
 27. getitem-8d5c6a7b1c97dc8ed9e10c049cc6c2be
 28. &lt;dask_awkward.lib.operations._ConcatenateFnAxisGT0-9ad4ca8ff26531037bb0cc11a7f2ad7b
 29. values-astype-2aa08a09a73ce9f519a33d832d4fb9e0
 30. pFCandsIdxG-d05662f0c636a8ba6ea4d2c8098e6724
 31. _apply_global_index-bca0b107ba20464e7274ff0057c9c5e4
 32. pFCandsIdxG-7d03c6ba83d0292b837070935e4f179f
 33. _apply_global_index-3fee5a0ad3d79adbd6a0b3548e419670
 34. dz-d84c08a881cdb8357cf60965fa9f0514
 35. absolute-621e2d660cd9416b3dcec859c51f492d
 36. add-832b07089f33f40fb7400a0d0fc2f056
 37. log-f8bc95274ee24348b4a9c761a2b3dd98
 38. pad-none-826aa3b61cfe7e95e4b97664e4838ee6
 39. fill-none-fc36a3bd147b79337086981e85e8b3e0
 40. getitem-2fcaebe4cad7140dabc447c856a1554d
 41. pFCandsIdxG-fe9303d1a0e50dbf3072a4acdb8e18da
 42. _apply_global_index-2a5bcce5b02484770cd000a274ebbaf2
 43. pFCandsIdxG-5ec68f469f4143bb528c7465f5acaed6
 44. _apply_global_index-f4e66cd12c20d5263f386ff0522fa064
 45. d0-d3afb63d9984e8866d7d4c9d12a78b68
 46. absolute-e10b15a7112e058001c6f750b725ebcb
 47. add-ddfff3a6ad28203867a6c95dbcbe8c92
 48. log-9d8a3462a857fc09ba36a62019ae3d6f
 49. pad-none-003013bd782852d5a8eb4eb65f2bfb38
 50. fill-none-d6d6dbcb020bba081e2941328868316f
 51. getitem-3d26ecbb9663c9447de86a7f22402303
 52. pt-c1c08a6f87adb59bc21fa26af117e088
 53. pFCandsIdxG-80130338d3935d06bbe9b5d92c0cd4a0
 54. _apply_global_index-1915fc96cf43d456c1f1da1e4f303d6d
 55. pFCandsIdxG-034ba70cc8a6e45005800a930daeb81d
 56. _apply_global_index-a1cc5d5d20b5db9ceb57fcfd576a9191
 57. pt-315a7084b6e4dab545ccadb5a0db1ef4
 58. divide-23fbc75b17f947f0900380ad2400c68f
 59. log-f0c4cf3c299d4e8ee17d7e77be599884
 60. pad-none-07caa722d36e199167481c1f614ae95d
 61. fill-none-d14724eabffff62abe0c1b6c09146055
 62. getitem-32f06961eb19fb2dbf4c7f981f5e1813
 63. pFCandsIdxG-72f4f07442540275be1f9035bafecd43
 64. _apply_global_index-bb29a2f3b8ac6d857d2e8be71992f7df
 65. pFCandsIdxG-355ce670f4252da6d0cf79a617b71ad7
 66. _apply_global_index-521fe6eb7254dce4894fd038838d89d4
 67. pt-67c848d59484c26a1fdd3e462d472e7b
 68. log-66c6953623e150d562859512627cabca
 69. pad-none-a50fc8156f9b07aaafd3cce56d43ae91
 70. fill-none-80fd6ae936e0efaa36a59e07ec7939cd
 71. getitem-8703b8d79d8ec80382d2b1776378497f
 72. pFCandsIdxG-c7aa707e27ed4ebeec227e4164931a3a
 73. _apply_global_index-864fdce0b5fb921805356148809a09a3
 74. pFCandsIdxG-40ebe488b5db2d7c7465e7ce37055cbb
 75. _apply_global_index-124147639902656cffbf1be792a05568
 76. delta-r-e26e7e27fd16d3b095c87281f84ab15b
 77. pad-none-0ee0161b4c9a8e7e6c93a80bd776d97c
 78. fill-none-f4957da021529a0e512ae5a3a00ddc8f
 79. getitem-da8190a602ae329b7519c504a4fb1f8e
 80. &lt;dask_awkward.lib.operations._ConcatenateFnAxisGT0-94da2cb85eb62883bb7ed60ccb3ec975
 81. values-astype-ec0a2f827e0ba814ec816efefcb57570
 82. pFCandsIdxG-473bd48d6c3864fea7e4b2cb000ada1d
 83. _apply_global_index-40b5e8c860542bfc1881443dcabcd3e8
 84. pFCandsIdxG-27f5b433f817655bd4ec25ccc0f63bec
 85. _apply_global_index-89427cf0f03a65aff27c761846405067
 86. delta-phi-e1ea313cebc1c707e8c2d7529afa15f6
 87. pad-none-6a21220ace9c2a30d93fbc4994526fd3
 88. fill-none-601b81a21345678251df6bc77fab9e0b
 89. getitem-d4d55e610305243a00ca2de75c288353
 90. pFCandsIdxG-3d0e8498e93670136a314a894c9b436d
 91. _apply_global_index-5d6192da248e624fa7bc8f2194c33fb9
 92. pFCandsIdxG-61299a8da18075b6fff8303f525acf77
 93. _apply_global_index-36bc916646db1e8b807a14b053c1fd92
 94. eta-47da89c5d868ac233b6251b7221b7a66
 95. eta-c44f6e7fabca938462b4e2ea68fca37d
 96. subtract-c3852dc5e9ffafcc05519f4978eddb54
 97. pad-none-759cb714701908c124f788730b7320e9
 98. fill-none-e3f8210381d08b7a71a11e857d066eab
 99. getitem-eba73f6ed6b09ec959d457903b73d39d
 100. &lt;dask_awkward.lib.operations._ConcatenateFnAxisGT0-3567704001a71a5020b605f689c2eaa9
 101. values-astype-381417681b50dd8d3274ab22a8a7f0d6
 102. numpy_call_ParticleNetExample1_143880bd51265ab5cb0ff3b61a1522c0-8a7fd3678eea90e891eb5b11dd380281

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_mltools_12_1.png" src="../_images/notebooks_mltools_12_1.png" />
</div>
</div>
<p>Or a peek at the optimized results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dask_results</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">optimize_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ensc/VirtualENV/coffea-test/lib/python3.8/site-packages/coffea/ml_tools/helper.py:163: UserWarning: No format checks were performed on input!
  warnings.warn(&#34;No format checks were performed on input!&#34;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_mltools_14_1.png" src="../_images/notebooks_mltools_14_1.png" />
</div>
</div>
</section>
<section id="Comments-about-generalizing-to-other-ML-tools">
<h2>Comments about generalizing to other ML tools<a class="headerlink" href="#Comments-about-generalizing-to-other-ML-tools" title="Permalink to this heading"></a></h2>
<p>All ML wrappers provided in the <code class="docutils literal notranslate"><span class="pre">coffea.mltools</span></code> module (<code class="docutils literal notranslate"><span class="pre">triton_wrapper</span></code> for <a class="reference external" href="https://catalog.ngc.nvidia.com/orgs/nvidia/containers/tritonserver">triton</a> server inference, <code class="docutils literal notranslate"><span class="pre">torch_wrapper</span></code> for pytorch, and <code class="docutils literal notranslate"><span class="pre">xgboost_wrapper</span></code> for <a class="reference external" href="https://xgboost.readthedocs.io/en/stable/">xgboost</a> inference) follow the same design: analyzers is responsible for providing the model of interest, along with providing an inherited class that overloads of the following methods to data type conversion:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">prepare_awkward</span></code>: converting awkward arrays to <code class="docutils literal notranslate"><span class="pre">numpy</span></code>-compatible awkward arrays, the output arrays should be in the format of a tuple <code class="docutils literal notranslate"><span class="pre">a</span></code> and a dictionary <code class="docutils literal notranslate"><span class="pre">b</span></code>, which can be expanded out to the input of the ML tool like <code class="docutils literal notranslate"><span class="pre">model(*a,</span> <span class="pre">**b)</span></code>. Notice some additional trivial conversion, such as the conversion to available kernels for <code class="docutils literal notranslate"><span class="pre">pytorch</span></code>, converting to a matrix format for <code class="docutils literal notranslate"><span class="pre">xgboost</span></code>, and slice of array for <code class="docutils literal notranslate"><span class="pre">triton</span></code> is handled automatically by the respective wrappers. To handle
both dask/non-dask arrays, the user should use the provided <code class="docutils literal notranslate"><span class="pre">get_awkward_lib</span></code> library switcher.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">postprocess_awkward</span></code> (optional): converting the trivial converted numpy array results back to the analysis specific format. If this is not provided, then a simple <code class="docutils literal notranslate"><span class="pre">ak.from_numpy</span></code> conversion results is returned.</p></li>
</ul>
<p>If the ML tool of choice for your analysis has not been implemented by the <code class="docutils literal notranslate"><span class="pre">coffea.mltools</span></code> modules, consider constructing your own with the provided <code class="docutils literal notranslate"><span class="pre">numpy_call_wrapper</span></code> base class in <code class="docutils literal notranslate"><span class="pre">coffea.mltools</span></code>. Aside from the functions listed above, you will also need to provide the <code class="docutils literal notranslate"><span class="pre">numpy_call</span></code> method to perform any additional data format conversions, and call the ML tool of choice. If you think your implementation is general, also consider submitting a PR to the <code class="docutils literal notranslate"><span class="pre">coffea</span></code> repository!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="processor.html" class="btn btn-neutral float-left" title="Coffea Processors" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="histograms.html" class="btn btn-neutral float-right" title="Coffea Histograms (deprecated)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Fermi National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>